---
title: "The Impact of Transmission Type on Fuel Economy"
author: "Jonathan Labin"
date: "October 21, 2015"
output: pdf_document
---

##Executive Summary
This report attempts to determine which transmission type is better for fuel economy: Manual or Automatic.  This analysis is performed using the mtcars dataset and develops a regression model to determine the fuel economy difference between the two types of transmission.  While the overall trends produced by the model indicate a difference, the variability and small sample size results in a confidence intervals such that the effect of transmission cannot be clearly distinguished.

##Load the data
This dataset is provided with R in the datasets library.  See ?mtcars for more information.
```{r}
library(datasets)
data(mtcars)
```

##Exploratory Analysis
We are interested determining a model which predicts fuel economy (mpg) based on a subset of the remaining variables.  As a first cut, let's explore the correlation between the remaining variables and mpg.  The fllowing lists the absolute values from the mpg row of the correlation matrix. 
```{r}
sort(round(abs(cor(mtcars)["mpg",]),3), decreasing=T)
```
Clearly mpg itself is exactly correlated.  Beyond that, it appears that weight (wt), the numer of cylinders (cyl) and the engine displacement (disp) are the highest correlated to economy.  It is expected that in general, the heavier the vehicle, the lower the fuel economy might be.  Displacement and number of cylinders are both a type of measures of engine size and so only one should be included in our model.  You might expect that a vehicle tuned to provide more horsepower (hp) may be less fuel efficient but this variable would also be very much dependent on engine size.

We also see that our target variable, transmission type (am) has a reletively low correlation to economy. Further exploration of the effect of this variable in the context of some of the others will be required.

The vs and am variables in this dataset are really factor variables where the flag values are not nessesarily numerically related so we convert these variables into factors.
```{r}
mtcars$vs <- factor(mtcars$vs, labels = c("V-engine", "Straight"))
mtcars$am <- factor(mtcars$am, labels = c("Automatic", "Manual"))
```

Figure 1 and Figure 2 shown in the appendix show the dominating relationships between fuel economy and the highest two correlated variables (wt, cly) and how those relationships differ for each transmission type (am).  Clearly, our models must take these highly influential variables into account in order to accurately model the effect of transmission type. 

##Fit Models
Let's explore building some models of this data.  The following models each begin with our target variable (am) annd add additional variables to the model.  We will then decide which variables are likely to be appropriate for our model with a alpha = 0.05 cutoff for the resulting p values.
```{r}
fit1 <- lm(mpg ~ am, mtcars)
fit2 <- update(fit1, mpg ~ am + wt)
fit3 <- update(fit2, mpg ~ am * wt)
fit4 <- update(fit3, mpg ~ am * wt + factor(cyl))
fit5 <- update(fit4, mpg ~ am * wt + factor(cyl) + drat)
round(anova(fit1, fit2, fit3, fit4, fit5)$`Pr(>F)`,4)
```
The above p-values indicate that the addition of weight (wt) and the combined wt:am factor both have a reasonably signifficant effect in our model.  Including the number of cylinders (cyl) is approaching our cuttoff but including drat is well outside usefulness here.
Figure 3 in the appendix shows the parallel prediction lines for model fit2.  Figure 4 in the appendix shows the prediction lines with different slopes for generated by model fit3.  The remaining models would require more advanced visualizations in order to view the additional dimensions.
We select fit4 which includes the interaction term wt and the a term for the cyl variable.

To confirm that our model is appropriately representing the variation in the data, Figure 5 provides the residual plots for the model.  These plots do not appear to reveal any systematic patterns in the residual data.  The error tearms appear to be normal in the Normal Q-Q plot.

Above, we selected fit4 = mpg ~ am + wt + factor(cyl) + am:wt as an appropriate model for our data.  This section inspects this model to make inferences about the relationship between transmission type and fuel efficiency.  First, let's look at the summary of the model coefficients:
```{r}
summary(fit4)$coef
```
```{r, echo=F,message=F, warning=F}
fit4Coef <- coef(fit4)
sumCoef <- summary(fit4)$coef
aSlopeInt <- sumCoef[3,1]+c(-1,1)*qt(.975,df=fit3$df)*sumCoef[3,2]
mSlopeMod <- sumCoef[6,1]+c(-1,1)*qt(.975,df=fit3$df)*sumCoef[6,2]
mSlopeInt <- c(aSlopeInt[1] + mSlopeMod[1], aSlopeInt[2] + mSlopeMod[2])
```

According to the exact values from this model, while holding all other variables constant, we expect a `r -round(fit4Coef[3],2)` drop in mpg for every 1,000 lbs increase in vehicle weight for automatic transmission vehicles and a `r -round(fit4Coef[3]+fit4Coef[6],2)` drop in  mpg for every 1,000 lbs increase in vehicle weight for manual transmission vehicles.  However, since the lines cross, neigher transmission dominates across all vehicle weights.  Instead, in weights below around `r round((fit4Coef[1]+fit4Coef[2] - fit4Coef[1])/(fit4Coef[3]-fit4Coef[3]-fit4Coef[6])*1000)` lbs, manual transmission vehicles result in higher fuel economy and automatic transmission vehicles produce better economy for vechicles above that weight.

However, all of the previous reasoning considers only the exact values.  When considering confidence intervals (at the 95% level), we expect between `r -round(aSlopeInt,2)[2]` and `r -round(aSlopeInt,2)[1]` drop in mpg for automatic transmission vehicles and between `r -round(mSlopeInt,2)[2]` and `r -round(mSlopeInt,2)[1]` drop in mpg manual transmission vehicles. 

These intervals contain a signifficant overlap even at the 95% confidence level.  From this it can not be concluded that transmission type has a signifficant effect on the fuel economy of the vehicles.  Perhaps with a larger dataset, the confidence intervals could be tightened to distinguish a difference.

#Appendix: Figures
```{r loadlibs,echo=F,message=F, warning=F}
library(GGally)
library(ggplot2)
library(grid)
library(gridExtra)
```
```{r, fig.height=3, echo=F,message=F, warning=F}
g1 = ggplot(data=mtcars, aes(y=mpg, x=wt, color=am)) + 
    geom_point() + 
    xlab("Vehicle Weight (lb/1000)") + ylab("Economy (mpg)") + 
    ggtitle("Figure 1.")
g2 = ggplot(data=mtcars, aes(y=mpg, x=factor(cyl), fill=am)) + 
    geom_violin(colour = "black", size=0.5) + 
    xlab("Number of Cylinders") + ylab("Economy (mpg)") + 
    ggtitle("Figure 2.")
grid.arrange(g1,g2,ncol=2)

g3 = g1 + geom_abline(intercept=coef(fit2)[1], slope = coef(fit2)[3], color="red") + 
    geom_abline(intercept=coef(fit2)[1]+coef(fit2)[2], slope = coef(fit2)[3], color="blue") + 
    ggtitle("Figure 3.")

g4 = g1 + geom_abline(intercept=coef(fit3)[1], slope = coef(fit3)[3], color="red") + 
    geom_abline(intercept=coef(fit3)[1]+coef(fit3)[2], slope = coef(fit3)[3]+coef(fit3)[4], color="blue") + 
    ggtitle("Figure 4.")
grid.arrange(g3,g4,ncol=2)

#g5 = ggplot(aes(x=predict(fit4), y=resid(fit4))) + 
#    xlab("Fitted values") + ylab("residuals") + 
#    ggtitle("Figure 5. Fit vs resid (model fit4)")
```
```{r, fig.height=6, echo=F,message=F, warning=F}
par(mfrow=c(2,2), oma=c(0,0,4,0))
plot(fit4)
title("Figure 5. Residual Analysis (model fit4)", outer=TRUE)
```